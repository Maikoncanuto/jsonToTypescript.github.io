<html>
    <head>
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>
    <body>
        <div class="container">
            <header>
                <div class="header-container">
                    <div class="header-logo">
                        <h1 class="header-title">JSON to TYPESCRIPT</h1>
                    </div>
                </div>
            </header>
            <section>
                <div class="textarea-container">
                    <h2 class="label-textarea">JSON</h2>
                    <textarea id="input-json">
{
    "autenticacaoAppResponse" : {
        "codigo" : "0",
        "numeroCpfCnpj" : "347475028",
        "ordemCnpj" : "0",
        "digitoCpfCnpj" : "31",
        "documentos" : [ {
        "codigoProduto" : "1",
        "numeroDocumento" : "45|531|3241444|19"
        }, {
        "codigoProduto" : "1",
        "numeroDocumento" : "12|531|807547|19"
        } ],
        "email" : "martinho_gf@hotmail.com",
        "nome" : "Rodrigo de Castro Macena",
        "codigoDispositivo" : "1",
        "idSessao" : "eyJhbGciOiJSUzUxMiJ9.eyJ1aWQiOiIzNDc0NzUwMjgzMSIsInNlc3NlZ3B0bCI6Ijk3am5RbEgza1RkWDZNbEtXV0VmdzFoMmwrbWVTOWZ0NTdBRVwvVmlPQnpBbEdDS1NuYnlNWkV6QlYzS0VoXC9uT05wK1E3M1poXC94U3JNMlVBdTRhZkhBPT0iLCJwc3JvbGUiOltdLCJleHBQb3J0YWwiOjE1MTYyNzczMjQsImlzcyI6Imh0dHBzOlwvXC93d3dzLnBvcnRvc2VndXJvLmNvbS5iciIsImNuIjoiMzQ3NDc1MDI4MzEiLCJwb3J0YWwiOjgsImV4cCI6MTUxNjI3NjQyNH0.objLhY0sCFalIh6PdFqWJr74aUsA0uC58jczEGLxcVn6_1JBTvtH5qKBkvKQV_h9KQMYT9UZblbPTIjyDScL77DAMz6hV3d4anWzSOFq8xg-RbtJFPCQdWKlL-ZDvlDRRhWylecah0Pr7mmJ-F14GCM_mbq3mR7t20jUjsYeB8hmvR7RHioaxAO3fjSg0cShdcGLEC5rqGMc7v5LLZxeQA_RUcxGWx3_v5Lh56RQmn4yzq_TcAamvdh6IZawuL1qUVDDZM4iEjvE2hlhPh-tZ2TQW6AGPxyJ9cu1ADtce9PZPFKNC1kWXk1upQdGIk8-t6nx97Hr7lMwsxudYT6DPg",
        "mensagem" : "mensagem de retorno quando ocorre sucesso na autenticação\nmessagem.ws.app.sucesso.autenticacao",
        "listaApolicesResumidas" : {
        "codigo" : "0",
        "mensagem" : "Sucesso",
        "listaApolicesResumidas" : {
            "apoliceResumida" : [ {
            "codigoConvenio" : 0,
            "codigoEmpresa" : 1,
            "codigoRamo" : 531,
            "codigoStatusDocumento" : "A",
            "codigoSucursal" : 45,
            "descricaoStatusDocumento" : "ATIVA",
            "documentosImpressao" : {
                "documentoImpressao" : [ {
                "caminhoDocumento" : "S5310450032414440000000000001920170329.PDF                  ",
                "codigoGCDE" : "261761860",
                "numeroItem" : 19,
                "tipoDocumento" : 2
                } ]
            },
            "fimVigenciaApolice" : "11/03/2018",
            "inicioVigenciaApolice" : "11/03/2017",
            "itens" : {
                "item" : [ {
                "codigoCategoriaTarifaria" : 10,
                "descricaoCategoriaTarifaria" : "VEICULOS DE PASSEIO                     ",
                "fimVigenciaItem" : "11/03/2018",
                "inicioVigenciaItem" : "11/03/2017",
                "numeroItem" : 19,
                "numeroPropostaIndividual" : 807547,
                "origemPropostaIndividual" : 12,
                "veiculo" : {
                    "anoFabricacaoVeiculo" : 2005,
                    "anoModeloVeiculo" : 2006,
                    "chassi" : "   935CHRFN06B505439",
                    "classeLocalizacao" : "METROPOLITANA DE SAO PAULO                        ",
                    "codigoClasseLocalizacao" : 11,
                    "codigoVeiculo" : 80135,
                    "descricaoTipoVeiculo" : "XSARA PICASSO                 ",
                    "descricaoVeiculo" : "GLX 2.0 16V 138 CV            ",
                    "marcaVeiculo" : "CITROEN        ",
                    "modeloVeiculo" : "GLX 2.0 16V 138 CV            ",
                    "placa" : "DSK1137",
                    "tipoVeiculo" : 20
                }
                } ]
            },
            "numeroApolice" : 3241444,
            "numeroEndosso" : 0,
            "segurado" : {
                "cpfCnpjSegurado" : "34747502831",
                "dataNascimento" : "05/07/1985",
                "enderecos" : {
                "endereco" : [ {
                    "bairro" : "VILA MEDEIROS       ",
                    "cep" : "02207060",
                    "cidade" : "SAO PAULO           ",
                    "complemento" : "               ",
                    "descricaoLogradouro" : "EILEM                                   ",
                    "estado" : "SP",
                    "numero" : "72",
                    "tipoLogradouro" : "R    "
                } ]
                },
                "nomeSegurado" : "RODRIGO DE CASTRO MACENA                          ",
                "telefones" : {
                "telefone" : [ {
                    "codigoDdd" : 11,
                    "codigoTipoTelefone" : 3,
                    "descricaoTipoTelefone" : "RESIDENCIAL",
                    "numeroTelefone" : "23097485"
                }, {
                    "codigoDdd" : 11,
                    "codigoTipoTelefone" : 11,
                    "descricaoTipoTelefone" : "CELULAR",
                    "numeroTelefone" : "988887241"
                } ]
                },
                "tipoPessoa" : "F"
            }
            }, {
            "codigoConvenio" : 0,
            "codigoEmpresa" : 1,
            "codigoRamo" : 531,
            "codigoStatusDocumento" : "A",
            "codigoSucursal" : 45,
            "descricaoStatusDocumento" : "ATIVA",
            "documentosImpressao" : {
                "documentoImpressao" : [ {
                "caminhoDocumento" : "S5310450027784600000000000001920160330.PDF                  ",
                "codigoGCDE" : "226084325",
                "numeroItem" : 19,
                "tipoDocumento" : 2
                } ]
            },
            "fimVigenciaApolice" : "02/01/2017",
            "inicioVigenciaApolice" : "02/01/2016",
            "itens" : {
                "item" : [ {
                "codigoCategoriaTarifaria" : 10,
                "descricaoCategoriaTarifaria" : "VEICULOS DE PASSEIO                     ",
                "fimVigenciaItem" : "02/01/2017",
                "inicioVigenciaItem" : "02/01/2016",
                "numeroItem" : 19,
                "numeroPropostaIndividual" : 26358299,
                "origemPropostaIndividual" : 12,
                "veiculo" : {
                    "anoFabricacaoVeiculo" : 2005,
                    "anoModeloVeiculo" : 2006,
                    "chassi" : "   935CHRFN06B505439",
                    "classeLocalizacao" : "METROPOLITANA DO RIO DE JANEIRO                   ",
                    "codigoClasseLocalizacao" : 18,
                    "codigoVeiculo" : 80135,
                    "descricaoTipoVeiculo" : "XSARA PICASSO                 ",
                    "descricaoVeiculo" : "GLX 2.0 16V 138 CV            ",
                    "marcaVeiculo" : "CITROEN        ",
                    "modeloVeiculo" : "GLX 2.0 16V 138 CV            ",
                    "placa" : "DSK1137",
                    "tipoVeiculo" : 20
                }
                } ]
            },
            "numeroApolice" : 2778460,
            "numeroEndosso" : 0,
            "segurado" : {
                "cpfCnpjSegurado" : "34747502831",
                "dataNascimento" : "05/07/1985",
                "enderecos" : {
                "endereco" : [ {
                    "bairro" : "VILA MEDEIROS       ",
                    "cep" : "02207060",
                    "cidade" : "SAO PAULO           ",
                    "complemento" : "               ",
                    "descricaoLogradouro" : "EILEM                                   ",
                    "estado" : "SP",
                    "numero" : "72",
                    "tipoLogradouro" : "R    "
                } ]
                },
                "nomeSegurado" : "RODRIGO DE CASTRO MACENA                          ",
                "telefones" : {
                "telefone" : [ {
                    "codigoDdd" : 11,
                    "codigoTipoTelefone" : 3,
                    "descricaoTipoTelefone" : "RESIDENCIAL",
                    "numeroTelefone" : "23097485"
                }, {
                    "codigoDdd" : 11,
                    "codigoTipoTelefone" : 11,
                    "descricaoTipoTelefone" : "CELULAR",
                    "numeroTelefone" : "988887241"
                } ]
                },
                "tipoPessoa" : "F"
            }
            } ]
        }
        }
    }
    }
                              
                    </textarea>
                </div>
                <div class="textarea-container">
                    <div class="textarea-header-container">
                        <h2 class="label-textarea">TYPESCRIPT</h2>
                        <!-- <button class="clipborad">COPY</button> -->
                    </div>
                    <textarea readonly="readonly" id="input-ts"></textarea>
                </div>
            </section>
            <footer>
                <!-- <a class="footer-by" href="#">by Daniel Lima</a> -->
                <div class="footer-container">
                    <button class="btn-submit" onclick="transform();">Process</button>
                </div>
            </footer>
        </div>
    </body>
    <script>

        let inputJson = document.getElementById("input-json");
        let inputTs = document.getElementById("input-ts");
        let output = "";

        function transform(){
            let output = "";
            clearStack();
            if(!isValidJson()){
                showMessage("JSON invalid");
                return;
            }
            const json = JSON.parse(inputJson.value);
            output += mapper(json);
            
            while(true){
                let stack = getObjectsStack();
                if(stack){
                    stack.forEach((obj, index) => {
                        output += mapper(obj.object, obj.name);
                        setNullObjectStack(index);
                    });

                    output = replaceObjectNames(output);
                    removeNullObjectsStack();
                    if(!getObjectsStack() || getObjectsStack().length == 0) break;
                }else{
                    break;
                }
            }

            inputTs.value = output;
        }

        function replaceObjectNames(output){
            const stack = getObjectsStack();
            if(stack){
                
                stack.forEach(obj => {
                    output = output.replace(`%${obj.name}%`, setCamelCase(obj.name));
                });
            }
            return output
        }

        function mapper(object, nameAttr){
            let str = setInitialInterface(object, nameAttr);
            for(var propertyName in object) { 
               let name = propertyName;
               let value = object[name];
                let type = getType(value, name);

               str += `     ${name}${type.optional? '?' : ''}: ${type.type};\n`
            }
            str += setEndInterface(object);
            return str;
        }

        function setInitialInterface(object, nameAttr){
           
            return `export interface ${nameAttr? setCamelCase(nameAttr) : 'MyObject'} {\n`;
        }

        function setEndInterface(object){
           return "};\n\n";
        }
        
        function isValidJson(){
            try{
                JSON.parse(inputJson.value);
            }catch(error){
                return false;
            }
            return true;
        }

        function showMessage(message){
            alert(message);
        }

        function getType(attribute, nameAttr){
            switch(typeof attribute){
                case "undefined": {
                    return {type: "undefined",optional: true};
                    break;
                }

                case "boolean": {
                    return  {type: "boolean"};
                    break;
                }

                case "object": {
                    if(attribute === null) return {type:"any",  optional: true};

                    if(isArray(attribute)){
                        if(attribute.length > 0){
                            let arrayType = getType(attribute[0], nameAttr);
                            return{type: `Array<${arrayType.type}>`};
                        }
                        return {type: "Array<any>",optional: true};
                    } 
                    
                    addObjectStack(attribute,nameAttr);
                    return {type: `%${nameAttr}%`};
                    break;
                }
                case "number": {
                    return {type: `number`};
                    break;
                }
                case "function": {
                    return {type:"Function"}
                    break;
                }

                case "string": {
                    if(isDate(attribute)) return {type:"Date"};
                    
                    if(attribute.length == 0) return  {type:"any",  optional: true};

                     if(attribute[attribute.length-2]== '(' && attribute[attribute.length-1]== ')') return  {type:"Function"};

                    return  {type:"string"}
                    break;
                }
            }
        }

        function isDate(attribute){
            const date = new Date(attribute);
            if(`${attribute}`.length < 10 || date ==  "Invalid Date") return false;
            return true
        }

        function isArray(attribute){
           if(Array.isArray(attribute)) return true;
           return false;
        }

        function setCamelCase(value){
            return `${value}`.charAt(0).toUpperCase() + `${value}`.slice(1);
        }

        function addObjectStack(object, name){
            let stack = getObjectsStack();
            if(!stack) stack = [];
            let index = stack.length;
            stack.push({name: name, object: object});
            localStorage.setItem(`stack`,JSON.stringify(stack));
            return index;
        }

        function getObjectsStack(object){
           return JSON.parse(localStorage.getItem("stack"));
        }

        function clearStack(){
           return localStorage.clear();
        }

        function setNullObjectStack(index){
           let stack = getObjectsStack();
           stack[index].object = null;
           localStorage.setItem(`stack`,JSON.stringify(stack));
        }

        function removeNullObjectsStack(){
           let stack = getObjectsStack();
           let aux = [];
           stack.forEach(obj => {
               if(obj.object != null) aux.push(obj);
           })
           localStorage.setItem(`stack`,JSON.stringify(aux));
        }
    
    </script>
</html>